create database libraryDB
use libraryDB
create table library( 
library_id int primary key identity (1,1),
library_name nvarchar(50) unique not null,
location nvarchar(50)not null,
contact_number int not null,
established_year int
)

create table Staff( 
staff_id  int primary key identity (1,1),
full_name nvarchar(100),
position nvarchar(50)not null,
contact_number int not null,
library_id int not null,
foreign key (library_id) references library(library_id)
ON DELETE CASCADE 
ON UPDATE CASCADE
)
create table Books( 
book_id int primary key identity (1,1),
title nvarchar(50)not null,
genre nvarchar(50) not null,
ISBN nvarchar (100) unique not null,
price decimal(7,2) check (price>0),
shelf_location nvarchar(50) not null,
availability_status BIT DEFAULT 1, -- true=1 , faulse=0 --
check (genre in ('fiction','nonfiction','reference','children')),
library_id int not null,
foreign key (library_id) references library(library_id)
ON DELETE CASCADE
ON UPDATE CASCADE
)
create table members(
 member_id int primary key identity(1,1),
full_name VARCHAR(100),
email nvarchar (100) unique not null,
phone nvarchar(20),
membership_start_date date not null
)
create table loans(
loan_id int primary key identity(1,1),
loan_date date not null,
due_date date not null,
return_date date null,
status nvarchar (20) not null DEFAULT 'Issued' ,
check (status in('Issued', 'Returned', 'Overdue')),
check (return_date IS NULL OR return_date >= loan_date),
member_id int not null,
book_id int not null,
foreign key (member_id) references members(member_id)
ON DELETE CASCADE
ON UPDATE CASCADE,
foreign key (book_id) references Books(book_id)
ON DELETE CASCADE
ON UPDATE CASCADE
)
create table payment (
payment_id int primary key identity(1,1) ,
payment_date date not null,
method nvarchar(30),
amount decimal(8,2) not null,
check (amount > 0),
loan_id int not null,
foreign key (loan_id) references loans(loan_id) 
on delete cascade
on update cascade
)
create table review (
review_id int primary key identity(1,1),
rating int not null,
check (rating between 1 and 5),
comments nvarchar(max) default 'No comments',
review_date date not null,
member_id int not null,
book_id int not null,
foreign key (member_id) references members(member_id) on delete cascade on update cascade,
foreign key (book_id) references books(book_id) on delete cascade on update cascade
)
ALTER TABLE library
ALTER COLUMN contact_number NVARCHAR(20) NOT NULL;

INSERT INTO Library (library_name, location, contact_number, established_year)
VALUES
('Muscat Central Library', 'Muscat', '96892412398', 1998),
('Salalah Public Library', 'Salalah', '96898232198', 2009);

SELECT 
    COLUMN_NAME,
    COLUMNPROPERTY(OBJECT_ID(TABLE_NAME), COLUMN_NAME, 'IsIdentity') AS IsIdentity
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_NAME = 'library';
USE master;
GO

DROP DATABASE libraryDB;
GO
CREATE DATABASE libraryDB;
GO

USE libraryDB;
GO

CREATE TABLE library (
    library_id INT IDENTITY(1,1) PRIMARY KEY,
    library_name NVARCHAR(50) UNIQUE NOT NULL,
    location NVARCHAR(50) NOT NULL,
    contact_number NVARCHAR(20) NOT NULL,
    established_year INT
);
INSERT INTO library (library_name, location, contact_number, established_year)
VALUES
('Muscat Central Library', 'Muscat', '96892412398', 1998),
('Salalah Public Library', 'Salalah', '96898232198', 2009);
SELECT * FROM library;
USE libraryDB;
GO
INSERT INTO members (full_name, email, phone, membership_start_date)
VALUES
('Ahmed Al-Harthy', 'ahmed.harthy@gmail.com', '0096891234567', '2023-01-10'),
('Fatma Al-Zadjali', 'fatma.z@gmail.com', '0096898765432', '2023-02-05');
SELECT * FROM members
ALTER TABLE Staff
ALTER COLUMN contact_number NVARCHAR(20) NOT NULL;

INSERT INTO Staff (full_name, position, contact_number, library_id)
VALUES
('Saeed Al-Rashdi', 'Head Librarian', '96898877665', 1),
('Muna Al-Hinai', 'Library Assistant', '96896655443', 2);
SELECT * FROM Staff
INSERT INTO Books (title, genre, shelf_location, price, ISBN, library_id)
VALUES
('Oman History Vol 2', 'nonfiction', 'Shelf A2', 160.00, '9789996909999', 1);

SELECT * FROM Books
INSERT INTO loans (member_id, book_id, loan_date, due_date)
VALUES
(1, 1, '2023-04-01', '2023-04-15'),
(2, 2, '2023-04-05', '2023-04-20');
SELECT * FROM loans
INSERT INTO payment (loan_id, payment_date, amount, method)
VALUES
(1, '2023-04-18', 10.00, 'Cash');
SELECT * FROM payment

INSERT INTO review (member_id, book_id, rating, review_date)
VALUES
(1, 1, 5, '2023-04-12');

INSERT INTO review (member_id, book_id, rating, comments, review_date)
VALUES
(2, 2, 4, 'Very informative book', '2023-04-15');
SELECT * FROM review
--DQL
--1. Display all book records
select* from Books
--2. Display each book’s title, genre, and availability
select title, genre,availability_status from Books
--3. Display all member names, email, and membership start date
select full_name, email, phone, membership_start_date from members
--4. Display each book’s title and price as BookPrice
select title , price as BookPrice from Books
--5. List books priced above 150 LE
select * from Books where price >150
--6. List members who joined before 2023
select * from members where  membership_start_date< '2023-12-31'
--7. Display books published after 2018
alter table books
add publish_year int
UPDATE Books
SET publish_year = 2015
WHERE title = 'Oman History';

UPDATE Books
SET publish_year = 2020
WHERE title = 'SQL Fundamentals';

UPDATE Books
SET publish_year = 2019
WHERE title = 'Arabian Tales';
select * from Books where publish_year > 2018
--8. Display books ordered by price descending
select* from Books order by price desc
--9. Display the maximum, minimum, and average book price
select 
MAX(price) As MaxPrice,
MIN(price) As MinPrice,
AVG(price) As AvgPrice
from Books
--10. Display total number of books
select count(*) As TotaleBooks from Books
--11. Display members with NULL email
select * from members where email is null
--12. Display books whose title contains 'Data'
select * from Books where title like '% Data%'
--DML
--13. Insert yourself as a member (Member ID = 405)
insert into members( full_name,email,phone,membership_start_date)
values('sheika','sheika02x2@gmail.com','95125165',GETDATE())
--14. Register yourself to borrow book ID = 1
select member_id, full_name from members
select book_id, title from Books
INSERT INTO loans (member_id, book_id, loan_date, due_date)
VALUES(3,1,GETDATE(),DATEADD(DAY, 14, GETDATE()))
--16. Update the return date of your loan to today
UPDATE loans
SET return_date = GETDATE(),
    status = 'Returned'
WHERE member_id = 405
  AND book_id = 1
  --17. Increase book prices by 5% for books priced under 200
  UPDATE Books
SET price = price *0.05
WHERE price < 200
--18. Update member status to 'Active' for recently joined members
select *from members
ALTER TABLE members
ADD status NVARCHAR(20) DEFAULT 'Inactive'
UPDATE members
SET status = 'Active'
WHERE membership_start_date >= '2023-12-31'
--19. Delete members who never borrowed a book
delete from members where member_id not in ( select distinct member_id from loans)
